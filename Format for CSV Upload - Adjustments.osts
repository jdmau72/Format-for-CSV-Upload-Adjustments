{"version":"0.3.0","body":"// author: Justin D. Mau\n// script parses the document to create a list of adjustment objects\n// it then generates a csv that can be uploaded to Netsuite to process all adjustments quickly\n\n\nclass Adjustment {\n  referenceNumber: string;\n  adjustmentAccount: string;\n  adjustmentAccountReason: string;\n  binNumber: string;\n  item: string;\n  location: string;\n  adjQtyBy: number;\n  lotNumber: string;\n  quantity: number;\n  division: string;\n  department: string;\n  date: string;\n\n  constructor(item: string, lot: string, quantity: number, bin: string, location: string){\n    this.referenceNumber = \"To Be Generated\";\n\n    // now check if the item is an implant or instrument\n    let category = findCategory(item);\n    if (category == 'instrument') {\n      this.adjustmentAccount = \"65390 Manufacturing Overhead : Instrument wear\";\n      this.adjustmentAccountReason = \"SI Transaction\";\n    } else if (category == 'implant') {\n      this.adjustmentAccount = \"65240 Manufacturing Overhead : Physical inventory adjustments\";\n      this.adjustmentAccountReason = \"HW Transaction\";\n    }\n\n    this.binNumber = bin;\n    this.item = item;\n    this.location = location;\n    this.adjQtyBy = this.quantity = quantity;\n    this.lotNumber = lot;\n    this.division = \"Hardware\";\n    this.department = \"265-Other OH - HW\";\n    this.date = new Date().toLocaleDateString()\n  }\n\n    getValues(): string[]{\n      return [this.referenceNumber, this.adjustmentAccount, this.adjustmentAccountReason,\n                this.binNumber, this.item, this.location, this.adjQtyBy.toString(), this.lotNumber, this.quantity.toString(), this.division, this.department, this.date];\n    }\n\n}\n\n\n// creates a list of adjustments accessible for all functions in the code\nlet adjustmentList: Adjustment[] = [];\n\n\n\n// MAIN -------------------------------------------------------------------------------------------------------------\nfunction main(workbook: ExcelScript.Workbook,\n  location: string = \"TRAYBUILD\") {\n\n  // Get the active cell and worksheet.\n  let selectedCell = workbook.getActiveCell();\n  let sheet = workbook.getFirstWorksheet();\n\n  let usedRange = sheet.getUsedRange();\n  let numRows = usedRange.getValues().length;\n\n\n  // first gets the column indices for each required value\n  let headerRange = sheet.getRange(\"A1:Z1\");\n  let adjColIndex = findColumn(\"LOT ADJ\", headerRange);\n  let lotColIndex = findColumn(\"Lot\", headerRange);\n  let itemColIndex = findColumn(\"Item Number\", headerRange);\n  let qtyColIndex = findColumn(\"QTY\", headerRange);\n  let binColIndex = findColumn(\"Bin Number\", headerRange);\n\n  // gets the bin number\n  let binNumber = sheet.getCell(1, binColIndex).getValue() as string;\n\n  // now loop through each item\n  for (let row = 1; row < numRows; row++){\n\n    // gets the values of each important category\n    let rowValues = sheet.getRangeByIndexes(row, 0, 1, 99).getValues()[0];\n    let adj = rowValues[adjColIndex] as string;\n    let lot = rowValues[lotColIndex] as string;\n    let item = rowValues[itemColIndex] as string;\n    let qty = rowValues[qtyColIndex] as number;\n\n  // if the adj col is empty, ignore\n    if (adj != \"\"){\n      \n      // checks to see if there are multiple lots for adjustments\n      let subAdjustments = adj.toString().split(\",\"); // tries to split if there are multiple lots for that one item\n      if (subAdjustments.length > 1) {\n\n        for (let i = 0; i < subAdjustments.length; i++)\n        {\n          let subAdj = subAdjustments[i].trim().split(\" \"); // splits each of those lots to get the qty and lot\n          let subAdjLot = subAdj[0].trim();\n          let subAdjQty = Number(subAdj[1].replace(/[()]/g, ''));\n\n          // creates an adjustment entry and adds to the list\n          let adjOut = new Adjustment(item, lot, (subAdjQty * -1), binNumber, location);  // one to remove the original lot number\n          let adjIn = new Adjustment(item, subAdjLot, subAdjQty, binNumber, location);  // one to add the new one\n          adjustmentList.push(adjOut);\n          adjustmentList.push(adjIn);\n        }\n\n      // otherwise it will just do the one lot adjustment\n      } else\n       {\n        // will try to split in case only some need the lot adjustment\n        let subAdj = adj.toString().trim().split(\" \"); // splits each of those lots to get the qty and lot\n\n        if (subAdj.length > 1) // if there is a quantity listed in the adj column\n        {\n          adj = subAdj[0].trim(); // replaces adjustment lot with the split lot\n          qty = Number(subAdj[1].replace(/[()]/g, '')); // replaces qty with the specified amount\n        }\n\n        let adjOut = new Adjustment(item, lot, (qty * -1), binNumber, location);\n        let adjIn = new Adjustment(item, adj, qty, binNumber, location);\n        adjustmentList.push(adjOut);\n        adjustmentList.push(adjIn);\n      }\n    }\n  }\n\n  console.log(adjustmentList);\n\n  // now generates a new sheet for those adjustments and formats it to fit the CSV upload\n  generateAdjustmentCSV(workbook, binNumber);\n}\n// end of MAIN ---------------------------------------------------------------------------------------------------------\n\n\n\n// HELPER FUNCTIONS ----------------------------------------------------------------------------------------\nfunction findColumn(searchTerm: string, headerRange: ExcelScript.Range){\n    // gets the values of the headers\n    let headers = headerRange.getValues()[0];\n    let adjCol = 0;\n\n    for (let col = 0; col < headers.length; col++){\n        if (headers[col].toString().toLowerCase() == searchTerm.toLowerCase()) {\n          adjCol = col;\n        }\n    }\n    return adjCol;\n}\n\n\n\nfunction generateAdjustmentCSV(workbook: ExcelScript.Workbook, bin: string){\n  // create new sheet for the adjustments\n  let adjSheet = workbook.addWorksheet(`${bin}-ADJ`)\n\n  // defines the headers\n  let headerRange = adjSheet.getRangeByIndexes(0, 0, 1, 12);\n  headerRange.setValues([[\"Reference #\", \"Adjustment Account\", \"Adjustment Account Reason\", \t\"Bin Number\",\t\"Item\",\t\"Location\",\t\"Adjust Qty. By\",\t\"Receipt Inventory Number\",\t\"Quantitiy\", \t\"Division\",\t\"Department\", \"Date\"]])\n\n  for (let row = 1; row < adjustmentList.length + 1; row++){\n    let adj = adjustmentList[row - 1].getValues();\n    adjSheet.getRangeByIndexes(row, 0, 1, 12).setValues([adj]);\n  }\n}\n\n\n\n// findCategory is currently very basic and is just for Cortera products\n// in the future, adding a database of instrument and implant codes would help extend to other products\nfunction findCategory(item: string){\n  if (item.substring(0, 4) == \"1509\" || item.substring(0, 4) == \"1505\"){\n    return \"instrument\";\n  } else {\n    return \"implant\";\n  }\n}\n// end of HELPER FUNCTIONS -------------------------------------------------------------------------------\n","description":"","noCodeMetadata":"","parameterInfo":"{\"version\":1,\"originalParameterOrder\":[{\"name\":\"location\",\"index\":0}],\"parameterSchema\":{\"type\":\"object\",\"required\":[\"location\"],\"properties\":{\"location\":{\"type\":\"string\",\"default\":\"TRAYBUILD\"}}},\"returnSchema\":{\"type\":\"object\",\"properties\":{}},\"signature\":{\"comment\":\"\",\"parameters\":[{\"name\":\"workbook\",\"comment\":\"\"},{\"name\":\"location\",\"comment\":\"\"}]}}","apiInfo":"{\"variant\":\"synchronous\",\"variantVersion\":2}"}